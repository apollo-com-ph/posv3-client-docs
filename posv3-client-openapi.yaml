openapi: "3.0.0"

info:
  title: POSv3 Client API
  version: "1.0"
  description: Connectivity between POSv3 PWA to local devices such as printers, cash drawers, card terminals and data storage. API also handles connectivity to the central servers to process various cloud functions like authentication, uploading of transactions and data synchronization.  

tags:
  - name: UserController
    description: API for user login and logout
  - name: DeviceController
    description: API for accessing devices like printer and cash drawer
  - name: DatastoreController
    description: API for accessing local data storage
  
servers:
  - url: http://localhost:81107/pos3/v1

security:
  - bearerAuth: []

paths:
  /login:
    post:
      tags: 
        - UserController
      summary: User login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserLoginRequest'
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserLoginResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  /logout:
    post:
      tags:
        - UserController
      summary: User logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericSuccessResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  /device/status/{device_id}:
    get:
      tags:
        - DeviceController
      summary: Get list of devices connected to POS. Status for all devices will be listed if no device_id is provided.
      parameters:
        - $ref: '#/components/parameters/device_id'
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeviceStatusResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  /device/test/{device_id}:
    post:
      tags:
        - DeviceController
      summary: Do a test action for the device to validate connectivity
      parameters:
        - $ref: '#/components/parameters/device_id'
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericSuccessResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  /device/reconnect/{device_id}:
    post:
      tags:
        - DeviceController
      summary: Reconnect to the device
      parameters:
        - $ref: '#/components/parameters/device_id'
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericSuccessResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  /device/configure/{device_id}:
    put:
      tags:
        - DeviceController
      summary: Set configuration for the device
      parameters:
        - $ref: '#/components/parameters/device_id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeviceConfigurationRequest'

      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericSuccessResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  /device/print/{device_id}:
    post:
      tags:
        - DeviceController
      summary: Send text data to the printer device
      parameters:
        - $ref: '#/components/parameters/device_id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DevicePrintRequest'
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericSuccessResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  /device/print_image/{device_id}/{image_filename}:
    post:
      tags:
        - DeviceController
      summary: Print image to the printer device
      parameters:
        - $ref: '#/components/parameters/device_id'
        - $ref: '#/components/parameters/image_filename'
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericSuccessResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  /device/cut_paper/{device_id}:
    post:
      tags:
        - DeviceController
      summary: Send cut command to the printer device
      parameters:
        - $ref: '#/components/parameters/device_id'
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericSuccessResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  /device/open_drawer/{device_id}:
    post:
      tags:
        - DeviceController
      summary: Open cash drawer device
      parameters:
        - $ref: '#/components/parameters/device_id'
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericSuccessResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

# TODO: filter by criteria
  /datastore/list/{document}:
    post:
      tags:
        - DatastoreController
      summary: List all data from document with optional criteria
      parameters:
        - name: document
          description: Name of the document to retrieve from
          in: path
          required: true
          schema:
            type: string
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentResultListResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

  /datastore/{document}/{id}:
    get:
      tags:
        - DatastoreController
      summary: Get document with ID
      parameters:
        - name: document
          description: Name of the document to retrieve from
          in: path
          required: true
          schema:
            type: string
        - name: id
          description: Identifier of the document to retrieve
          in: path
          required: true
          schema:
            type: string
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentResultResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'
    post:
      tags:
        - DatastoreController
      summary: Update document with ID
      parameters:
        - name: document
          description: Name of the document to update
          in: path
          required: true
          schema:
            type: string
        - name: id
          description: Identifier of the document to update
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentResultResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'


  /datastore/{document}:
    post:
      tags:
        - DatastoreController
      summary: Create a new document
      parameters:
        - name: document
          description: Name of the document to create
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentResultResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BadRequestResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnauthorizedResponse'
        '500':
          description: Internal Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InternalErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    device_id:
      name: device_id
      in: path
      description: Identifier of the device
      required: true
      schema:
        type: string

    image_filename:
      name: image_filename
      in: path
      description: Filename of the image to print
      required: true
      schema:
        type: string

  schemas:
    GenericSuccessResponse:
      description: Generic success response
      type: object
      properties:
        message:
          type: string
          description: Success message
          default: Success
        code:
          type: integer
          description: Success code
          default: 200
      required:
        - message
        - code

    UnauthorizedResponse:
      description: Unauthorized response
      properties:
        message:
          type: string
          description: Unauthorized message
          default: Unauthorized
        code:
          type: integer
          description: Unauthorized code
          enum:
            - 4010  # General unauthorized
            - 4011  # Invalid token
            - 4012  # Token expired
            - 4013  # Insufficient permissions
            - 4014  # User not found
            - 4015  # Wrong password
            - 4016  # Account locked
      required:
        - message
        - code
    
    InternalErrorResponse:
      description: Internal error response
      properties:
        message:
          type: string
          description: Error message
          default: Internal error
        code:
          type: integer
          description: Error code
          default: 50000  # General error
      required:
        - message
        - code

    BadRequestResponse:
      description: Bad request error response
      properties:
        fields:
          type: array
          description: List of fields with errors
          items:
            type: object
            properties:
              field:
                type: string
                description: Field with error
                example: field1
              message:
                type: string
                description: Error message
                example: Field is required
        message:
          type: string
          description: Error message
          default: Bad request
        code:
          type: integer
          description: Error code
          default: 40000  # General error
      required:
        - message
        - code
          
    UserLoginRequest:
      description: User login request
      properties:
        username:
          type: string
          description: Username for the user logging in
          example: user1
        password:
          type: string
          description: Password for the user hashed using SHA256
          example: 5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8
      required:
        - username
        - password

    UserLoginResponse:
      description: User login response
      properties:
        token:
          type: string
          description: JWT token for the user
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InRlc3QiLCJpYXQiOjE1MTYyMzkwMjJ9.3Jv5
        permissions:
          type: array
          description: List of permissions for the user
          items:
            type: string
            example: ["DEVICE_MAINTENANCE", "DEVICE_USER"]
        message:
          type: string
          description: Success message
          default: Login successful
        code:
          type: integer
          description: Success code
          default: 200
      required:
        - token
        - permissions
        - message
        - code

    DeviceStatusResponse:
      description: Device status response
      properties:
        devices:
          type: array
          items:
            type: object
            properties:
              device_id:
                type: string
                description: Identifier of the device
                example: posiflex_printer_1
              name:
                type: string
                description: Name for the device
                example: Posiflex Printer 1
              type:
                type: string
                description: Type of device
                enum:
                  - PRINTER
                  - CASH_DRAWER
                  - LINE_DISPLAY
              status:
                type: string
                description: Status of the device
                enum:
                  - CONNECTED
                  - DISCONNECTED
                  - ERROR
              configurations:
                type: array
                items:
                  type: object
                  properties:
                    key:
                      type: string
                      description: Configuration key
                      example: printer_paper_width
                    value:
                      type: string
                      description: Configuration value
                      example: 80mm
        message:
          type: string
          description: Success message
          default: Device status retrieved
        code:
          type: integer
          description: Success code
          default: 200

    DeviceConfigurationRequest:
      description: Device configuration request
      type: object
      properties:
        configurations:
          type: array
          items:
            type: object
            properties:
              key:
                type: string
                description: Configuration key
                example: printer_paper_width
              value:
                type: string
                description: Configuration value
                example: 80mm
      required:
        - configurations

    DevicePrintRequest:
      description: Device print request
      type: object
      properties:
        text:
          type: string
          description: Text data to print. Use markdown for formatting.
          example: Test Print\n\nThis is a test print
        cut-after:
          type: boolean
          description: Cut the paper after printing
          default: false
        logo-before:
          type: boolean
          description: Print header logo before the text body
          default: false
        logo-after:
          type: boolean
          description: Print header logo after paper had been cut
          default: false
      required:
        - text

    DocumentResultListResponse:
      description: Result list response
      type: object
      properties:
        results:
          type: array
          description: List of results
          items:
            type: object
            description: Result item
          default: []
        result_size:
          type: integer
          description: Number of results
          default: 0
        message:
          type: string
          description: Success message
          default: Success
        code:
          type: integer
          description: Success code
          default: 200
      required:
        - results
        - result_size
        - message
        - code

    DocumentResultResponse:
      description: Document result response
      type: object
      properties:
        id: 
          type: string
          description: Identifier of the document
          example: 123456
        result:
          type: object
          description: Document data
          default: null
        message:
          type: string
          description: Success message
          default: Success
        code:
          type: integer
          description: Success code
          default: 200
      required:
        - message
        - code

    ProductDocument:
      description: Product document
      type: object
      properties:
        id:
          type: string
          description: Identifier of the product
          example: 123456
        long_name:
          type: string
          description: Unabbreviated name of the product
          example: Product 1
        short_name:
          type: string
          description: Abbreviated name of the product
          maxLength: 50
          example: Prod1
        identifiers:
          type: array
          description: Identifiers assigned to the product
          items:
            type: object
            $ref: '#/components/schemas/ProductIdentifierDocument'
          example: [{id: 123456, type: SKU}]
        catalog_category:
          type: object
          description: Category of the product
          $ref: '#/components/schemas/CategoryDocument'
          example: {id: 123e4567-e89b-12d3-a456-426614174000, name: Food, type: CATALOG_CATEGORY}
        catalog_subcategory:
          type: string
          description: Subcategory of the product
          $ref: '#/components/schemas/CategoryDocument'
          example: {id: 123e4567-e89b-12d3-a456-426614174001, name: Snacks, type: CATALOG_SUBCATEGORY}
        catalog_super_category:
          type: string
          description: Super category of the product
          $ref: '#/components/schemas/CategoryDocument'
          example: {id: 123e4567-e89b-12d3-a456-426614174002, name: Grocery, type: CATALOG_SUPER_CATEGORY}
        categories:
          type: array
          description: List of categories assigned to the product
          items:
            type: object
            $ref: '#/components/schemas/CategoryDocument'
          example: [{id: 123e4567-e89b-12d3-a456-426614174000, name: Food, type: CATALOG_CATEGORY}]
        image_url:
          type: string
          description: Filename of the product image
          example: images/product/product1.jpg
        prices:
          type: array
          description: Prices of the product
          items:
            type: object
            $ref: '#/components/schemas/ProductPriceDocument'
          example: [{price: 10.00, currency: PHP, type: RETAIL, start_date: 2021-01-01T00:00:00Z, end_date: 2021-12-31T23:59:59Z}]
        costs:
          type: array
          description: Costs of the product
          items:
            type: object
            $ref: '#/components/schemas/ProductPriceDocument'
          example: [{price: 5.00, currency: PHP, type: COST, start_date: 2021-01-01T00:00:00Z, end_date: 2021-12-31T23:59:59Z}]
        tax_rate:
          type: number
          description: Tax rate of the product
          example: 0.12
        is_consigned:
          type: boolean
          description: Is the product consigned
          default: false
        discontinued_date:
          type: string
          description: Date when the product was discontinued
          format: date-time
          example: 2021-01-01T00:00:00Z
        date_created:
          type: string
          description: Date created of the product document
          format: date-time
          example: 2021-01-01T00:00:00Z
        last_updated:
          type: string
          description: Last updated date of the product document
          format: date-time
          example: 2021-01-01T00:00:00Z
#       brand:
#       attributes:
#       cross_sell_products:
#       bill_of_materials:
      required:
        - id
        - long_name
        - short_name
        - identifiers
        - catalog_category
        - categories
        - prices
        - tax_rate
        - is_consigned
        - date_created
        - last_updated

    ProductIdentifierDocument:
      description: Product identifier document
      type: object
      properties:
        id:
          type: string
          description: Identifier of the product identifier
          example: 123456
        type:
          type: string
          description: Type of the product identifier
          example: SKU
      required:
        - id
        - type

    CategoryDocument:
      description: Category document
      type: object
      properties:
        id:
          type: string
          description: Identifier of the category
          example: 123e4567-e89b-12d3-a456-426614174000
        name:
          type: string
          description: Name of the category
          example: Food
        type:
          type: string
          description: Type of the category
          example: CATALOG_CATEGORY
      required:
        - id
        - name
        - type

    ProductPriceDocument:
      description: Product price document
      type: object
      properties:
        price:
          type: number
          description: Price of the product
          example: 10.00
        currency:
          type: string
          description: Currency of the price
          example: PHP
        type:
          type: string
          description: Type of the price
          example: RETAIL
        start_date:
          type: string
          description: Start date of the price
          format: date-time
          example: 2021-01-01T00:00:00Z
        end_date:
          type: string
          description: End date of the price
          format: date-time
          example: 2021-12-31T23:59:59Z
      required:
        - price
        - currency
        - start_date
        - end_date

    BarcodeDocument:
      description: Barcode document
      type: object
      properties:
        barcode:
          type: string
          description: Barcode value
          example: 1234567890123
        product:
          type: object
          description: Product associated with the barcode
          properties:
            id:
              type: string
              description: Identifier of the product
              example: 123456
            long_name:
              type: string
              description: Unabbreviated name of the product
              example: Product 1
            short_name:
              type: string
              description: Abbreviated name of the product
              maxLength: 50
              example: Prod1
        start_date:
          type: string
          description: Start date of the barcode
          format: date-time
          example: 2021-01-01T00:00:00Z
        end_date:
          type: string
          description: End date of the barcode
          format: date-time
          example: 2021-12-31T23:59:59Z
        date_created:
          type: string
          description: Date created of the barcode document
          format: date-time
          example: 2021-01-01T00:00:00Z
        last_updated:
          type: string
          description: Last updated date of the barcode document
          format: date-time
          example: 2021-01-01T00:00:00Z
      required:
        - id
        - barcode
        - type
        - date_created
        - last_updated

    PosMenuDocument:
      description: POS menu document
      type: object
      properties:
        items:
          type: array
          description: List of menu items
          items:
            type: object
            $ref: '#/components/schemas/MenuItemDocument'
            example: [{id: 123456, label: Menu Item 1, product: {id: 123456, long_name: Product 1, short_name: Prod1}, image_url: images/product/product1.jpg, foreground_color: \#000000, background_color: \#FFFFFF}]
        date_created:
          type: string
          description: Date created of the menu document
          format: date-time
          example: 2021-01-01T00:00:00Z
        last_updated:
          type: string
          description: Last updated date of the menu document
          format: date-time
          example: 2021-01-01T00:00:00Z

    MenuItemDocument:
      description: Menu item document
      type: object
      properties:
        id:
          type: string
          description: Identifier of the menu
          example: 123e4567-e89b-12d3-a456-426614174000
        label:
          type: string
          description: Display label of the menu item
          example: Menu 1
        product:
          type: object
          description: Product associated with the menu item
          properties:
            id:
              type: string
              description: Identifier of the product
              example: 123456
            long_name:
              type: string
              description: Unabbreviated name of the product
              example: Product 1
            short_name:
              type: string
              description: Abbreviated name of the product
              maxLength: 50
              example: Prod1
        image_url:
          type: string
          description: Filename of the menu item image
          example: images/product/product1.jpg
        foreground_color:
          type: string
          description: Foreground color of the menu item
          example: #000000
        background_color:
          type: string
          description: Background color of the menu item
          example: #FFFFFF
        date_created:
          type: string
          description: Date created of the menu document
          format: date-time
          example: 2021-01-01T00:00:00Z
        last_updated:
          type: string
          description: Last updated date of the menu document
          format: date-time
          example: 2021-01-01T00:00:00Z
      required:
        - label
        - date_created
        - last_updated